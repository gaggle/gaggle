<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Jon Lauridsen</title><meta name="description" content=""><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="/main.css"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item home"><a href="/" target="_self" class="link">Home</a></li><li class="nav-list-item blog"><a href="/blog/" target="_self" class="link active">Blog</a></li></ul><hr></header><section class="container"><article data-datetime='"2016-12-08T23:17:21.000Z"' class="post-block"><div class="info"><h1 class="title"><a href="/blog/2016/end-to-end-testing-with-webdriverio-sauce-labs/" target="_self" class="link">End-to-end Testing with WebdriverIO + Sauce Labs</a></h1><div class="date">Dec 8, 2016</div><div title="Pre-release alpha" class="post-state alpha">Alpha</div></div><div class="content"><div class="excerpt"><p>After writing an article on <a href="/blog/2016/selenium-testing-with-ruby-javascript-and-python/">Selenium testing with Ruby, JS, and Python</a> I needed to make it available somewhere, and decided to host it from my own site. But that meant adding new functionality, and surely I’d want to test that functionality given the topic I’m writing about!</p><p>However my site’s backend is JavaScript and I wasn’t so fond of the JS framework for testing, so what to do?</p></div><div class="more"><p>Well, with great timing <a href="http://www.kevinlamping.com">Kevin Lamping</a> happened to tweet about how nice <a href="http://webdriver.io">WebdriverIO</a> is, so I went to give it a try since I had passed it over in my previous article.</p><blockquote class="twitter-tweet" data-conversation="none" data-lang="en"><p lang="en" dir="ltr"><a href="https://twitter.com/jonlauridsen">@jonlauridsen</a> you&#39;ve got to check <a href="https://twitter.com/webdriverio">@webdriverio</a> out. simplifies so many things</p>&mdash; Kevin Lamping (@klamping) <a href="https://twitter.com/klamping/status/800756403057082368">November 21, 2016</a></blockquote><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script><p>I ended up using WebdriverIO as part of my fully automated deployment process, by combining the continuous integration service <a href="http://travis-ci.org">Travis</a> and multi-browser testing service <a href="https://saucelabs.com">Sauce Labs</a>. With this article we’ll go through the details of setting it all up.</p><h1>Not so fast</h1><p>I did actually try WebdriverIO for my previous article, but it threw errors during <code>npm install</code> which left a bad taste so I gave it a pass. That was a shame though, because it turns out WebdriverIO is a great framework.</p><p>What actually went wrong is that a dependency of <code>webdriverio</code> needs to be compiled if you’re on Node 7, and <strong>it</strong> can’t be compiled with Python 3 which happens to be my system default. In hindsight it’s a simple fix (activate Python 2.7 for this project’s folder via <a href="https://github.com/yyuu/pyenv"><code>pyenv</code></a>), but it took a bit of work to figure out that this was the issue.</p><p>Travis fails to install the library for the same reason, and configuring Travis to build the library proved difficult. I actually gave up on this part and instead specified Node 6 for Travis’ configuration… I’m unlikely to hit critical version differences and hopefully no-one gets hurt from this subpar solution :)</p><h1>WebdriverIO</h1><p>Thankfully once it’s installed it works great. WebdriverIO has a nice predictable DSL that results in simple and very readable page objects and tests:</p><script src="//gist.github.com/gaggle/01d9b9f6f71a31789d03a5f8a656481d.js"></script><script src="//gist.github.com/gaggle/a4a822ec5bea81a992157f77c9d628d6.js"></script><p>That’s all it took to get going with local <abbr title="End-to-end">E2E</abbr> tests, really quite painless.</p><p>So, that’s the hard part done, right?</p><p>Not quite.</p><h1>Travis &amp; Sauce Labs</h1><p>UI tests need to run across multiple real browsers, because only by running on browsers really used by customers can we know that things <strong>actually</strong> work. But I don’t want to install and maintain a mess of browsers myself, so we turn to services like <a href="https://saucelabs.com">Sauce Labs</a>.</p><p>It took me a whole day getting all this working but hopefully this article will get you going quickly. There are basically three critical pieces of configuration to be aware of for success:</p><ul><li><strong>Correctly specify which browsers Sauce Labs should run</strong></li><li><strong>Ensure Sauce Labs browsers can see your site</strong></li><li><strong>Configure WebdriverIO to use Sauce Labs</strong></li></ul><p>First the basics though: Sauce Labs’ credentials must be added to Travis, this is done via Travis’ <a href="https://docs.travis-ci.com/user/environment-variables/#Defining-encrypted-variables-in-.travis.yml">encrypted environment variables</a> system. Then we must host the site from Travis’ <abbr title="Virtual machine">VM</abbr> (in my case that means running my site generator’s server), and set Travis to use “Sauce Connect” (a secure tunnel that lets Sauce Labs visit locally hosted sites).</p><p>These are pretty simple steps to set up, you can see <a href="https://github.com/gaggle/gaggle/blob/286d6bf4ddd9c1047b4433227acde0bdcff4161a/.travis.yml"><code>travis.yml</code></a> for these settings.</p><h2>Browsers</h2><p>Next we need to specify which browsers Sauce Labs should use to run our tests. WebdriverIO specifies a browser like this:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"safari-os-x-10.11-latest"</span>: &#123;</div><div class="line">    <span class="attr">"base"</span>: <span class="string">"SauceLabs"</span>,</div><div class="line">    <span class="attr">"browserName"</span>: <span class="string">"safari"</span>,</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"ui-safari-os-x-10.11-latest"</span>,</div><div class="line">    <span class="attr">"platform"</span>: <span class="string">"OS X 10.11"</span>,</div><div class="line">    <span class="attr">"version"</span>: <span class="string">"latest"</span>,</div><div class="line">    <span class="attr">"tunnel-identifier"</span>: [process.env.TRAVIS_JOB_NUMBER],</div><div class="line">    <span class="attr">"build"</span>: [process.env.TRAVIS_BUILD_NUMBER]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>But note how the key and <code>name</code> is duplicated and is a concatenation of the other data, and <code>base</code> and some other fields are just static data. It quickly becomes an inflexible mess to specify multiple browsers like this, it’s more maintainable to <abbr title="Don't repeat yourself">DRY</abbr> it up by <strong>generating</strong> the data WebdriverIO expects. It’s not so important how that’s done as long as we boil down our browser data to just the relevant bits. Here’s the minimum configuration data I settled on:</p><script src="https://gist-it.appspot.com/github/gaggle/gaggle/blob/286d6bf4ddd9c1047b4433227acde0bdcff4161a/saucelabs-browsers.js?slice=3:8"></script><p>(You can <a href="https://github.com/gaggle/gaggle/blob/286d6bf4ddd9c1047b4433227acde0bdcff4161a/saucelabs-browsers.js">see the full file</a> for how I generate the entire data structure)</p><h2>Enable Sauce Labs</h2><p>Then WebdriverIO needs to be configured to use Sauce Labs. This boils down to configuring <code>wdio.conf.js</code>, but doing so without <strong>requiring</strong> Sauce Labs because then we’d lose the ability to run the tests locally.</p><p>It comes down to changing a handful of variables depending on if Sauce Labs is present or not. Here’s how I did it:</p><script src="https://gist-it.appspot.com/github/gaggle/gaggle/blob/master/wdio.conf.js?slice=1:16"></script><p>With all that in place Travis now runs the tests per pull-request, pretty sweet!</p><blockquote><img src="/blog/2016/end-to-end-testing-with-webdriverio-sauce-labs/github-pr-checks-passed.png" alt="Pull-request 41 with automated tests passing" title="Pull-request 41 with automated tests passing"><footer><strong>GitHub</strong><cite><a href="https://github.com/gaggle/gaggle/pull/41">Pull-request 41 with automated tests passing</a></cite></footer></blockquote><h2>Stability</h2><p>At this point I recommend investing some time to be certain the tests are stable. I made sure to work on a number of small incremental features, each going into open pull-requests that I updated frequently. This was to stress-test the UI tests against flakiness, because having flaky tests is almost worse than no tests at all.</p><p>I also purposefully started with completely simple tests, that way I could stress-test the process itself instead of having to debug the tests. Thankfully the setup runs very stable, the tests basically always run correctly.</p><p>Wait, “<em>basically</em>”?</p><p>Yeah…</p><blockquote><img src="/blog/2016/end-to-end-testing-with-webdriverio-sauce-labs/saucelabs-almost-all-passing.png" alt="One test failed randomly" title="One test failed randomly"><footer><strong>SauceLabs</strong><cite><a href="https://saucelabs.com/beta/builds/474a9716d17f46be9a31dd090cda9766">One test failed randomly</a></cite></footer></blockquote><p>That one red entry is where Microsoft Edge failed to start for no apparent reason, and the only action I took was to manually re-invoke the Travis job. That made everything pass just fine. There are unfortunately so many moving parts glued together here that invariably something fails. Maybe a setting can be tweaked to help against this, but for now it happens so rarely it’s not a real impediment.</p><p>It sure is annoying though!</p><h1>In the end</h1><p>So what’s the point of all this effort?</p><p>Well first of all it’s just fantastic seeing a pull-request marked green knowing the site has just been tested on multiple real browsers. It gives confidence that the code coming in isn’t totally ruining the product.</p><p>Another huge benefit is that we can visually inspect how the tests ran, Sauce Labs captures screenshots of all the states and we can play them back step by step.</p><blockquote><img src="/blog/2016/end-to-end-testing-with-webdriverio-sauce-labs/saucelabs-screenshot-431-ui-safari-os-x-10-11-latest.png" alt="Sauce Labs testing a page" title="Sauce Labs testing a page"><footer><strong>Sauce Labs</strong><cite><a href="https://saucelabs.com/beta/tests/4cc3effb11aa4cd8b04b4e8cb303ae1c/commands?enabledFilters=hasScreenshot#3">Build 431 ui-safari-os-x-10-11-latest</a></cite></footer></blockquote><p>It’s very powerful to flip through the various screenshots to quickly do visual inspection.</p><p>As a side bonus we also get this nice badge to proudly display:</p><blockquote><img src="/blog/2016/end-to-end-testing-with-webdriverio-sauce-labs/saucelabs-badge.svg" alt="saucelabs-badge.svg"><footer><strong>SauceLabs</strong><cite>Badge of browsers passing our tests</cite></footer></blockquote><h1>Conclusion</h1><p>Ultimately WebdriverIO and Sauce Labs are pleasant to work with, despite taking a whole day to set up. At least once it all works it works very nicely.</p><p>It’s a huge joy to have this completely automated continuous integration/deployment process, and it’s already caught a couple dumb mistakes I was about to merge to master.</p><p>Special thanks to Travis and Sauce Labs for providing free tiers of their services, it’s frankly unbelievable to have free access to professional-grade CI and cross-platform browser testing.</p><p>If you have any comments or questions <a href="https://twitter.com/jonlauridsen">I’d love to hear them</a>, and <a href="https://github.com/gaggle/gaggle">all the code is freely available</a> if you’d like to play around yourself.</p></div></div></article><div class="paginator"><a href="/blog/2016/selenium-testing-with-ruby-javascript-and-python/" class="prev">Newer</a><a href="/blog/2016/the-trouble-with-python-packaging/" class="next">Older</a></div><div id="disqus_thread"></div><script>var disqus_config=function(){this.page.url="http://jonlauridsen.com/blog/2016/end-to-end-testing-with-webdriverio-sauce-labs/",this.page.identifier="blog/2016/end-to-end-testing-with-webdriverio-sauce-labs/"};!function(){var e=document,t=e.createElement("script");t.src="//jonlauridsen.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></section><footer><section class="author-info"><img src="/img/jon.jpg" alt="Picture of Jon Lauridsen" class="image profile-pic"><div class="name">Jon Lauridsen</div><div class="blurb">Software developer, and automated quality assurance aficionado.</div></section><section class="site-info"><div class="last-build">Updated <abbr title="April 17th 2017, 10:28:29" data-datetime="2017-04-17T10:28:29+00:00" class="relative-time">Apr 17th</abbr></div><div class="credit">Powered by <a href="https://hexo.io">Hexo</a></div></section></footer></div><script src="/main.js"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-22672641-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script id="dsq-count-scr" async src="//jonlauridsen.disqus.com/count.js"></script></body></html>